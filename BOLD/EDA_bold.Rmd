---
title: "EDA BOLD"
author: "Lorena Malpica"
date: "17 de mayo de 2018"
output: html_document
---

# Datos de BOLD

El dataset se descargó directamente desde la página de BOLD, haciendo la búsqueda para "México". 

El script EDA_bold.R se ocupó para hacer la primera exploración de los datos. Las partes de este script se irán explicando a continuación:

```{r,  warning=FALSE, message=FALSE}
setwd( "/home/lmalpica/Desktop/CONABIO")
library(readr)
library(dplyr)
library(tidyr)

bold_data <- read_delim("./bold_data.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
bold_data<-as.data.frame(bold_data)


```

En los pasos que siguen se vio una discrepancia entre los nombres de algunos phylum en BOLD y en NCBI, como la mayoría de los reinos se obtuvieron de taxonomy NCBI y además pensando en que despues todo va a ser una única base de datos, se modificaron a mano estos nombres:

```{r,  warning=FALSE, message=FALSE}

bold_data[bold_data$phylum_name=="Chlorarachniophyta", 10]<-"Chlorarachniophyceae"
bold_data[bold_data$phylum_name=="Glomeromycota",10]<-"Glomeromycotina"
bold_data[bold_data$phylum_name=="Phoronida",10]<-"Phoroniformea"


```


El script fileprocessing.sh contiene one-liners de bash que se ocuparon para buscar descargar los reinos de ncbi. 

Primero se generó una lista de los phylum:

```
cat bold_data.tsv | awk -F "\t" '{print $10}' | sort | uniq > bold_phylum.txt
```

Esta lista se introdujo en la página de taxonomy para crear una lista de los ids de cada phylum. Este archivo es tax_bold y tiene el id en la columna 7.

```
cat tax_bold.txt | awk -F "\t" '{print  $7}' | sort | uniq > taxid.txt
```

Con estos ids, utilizando entrez utilities se obtuvieron los reinos para cada phylum. Esto se hizo con el script retrieve_taxbold.sh


```
efetch -db taxonomy -id 10190,10232,120557,1224,1264859,13809,1760,183924,20117414504,27563,2763,2836,287987,28889,29178,29197,3041,3195,3208,3398,35493,451507,451827,451828,4890,5204,58020,5878,6040,6073,6157,6231,6340,6447,6656,7586,7711 -format xml | xtract -pattern Taxon -element TaxId ScientificName -block "*/Taxon" -if Rank -equals kingdom -element ScientificName > phylumid_kingdom.tsv
```

Se importan los datos de los reinos de cada phylum:

```{r,  warning=FALSE, message=FALSE}
phylumid_kingdom <- read_delim("./phylumid_kingdom.tsv",  "\t", escape_double = FALSE, col_names = FALSE, trim_ws = TRUE)
colnames(phylumid_kingdom)<-c("phylum_id", "phylum_name", "kingdom")

```

Ahora éstos se revisaron a mano y se modificaron algunos detalles:

Actinobacteria esta repetida porque al extraer los ids, NCBI lo regresa dos veces con ids diferentes uno en el que se refieren a:
1)Actinobacteria como phylum (id:201174)  
2)Actinobacteria como clase, este ultimo se elimino

```{r,  warning=FALSE, message=FALSE}
phylumid_kingdom<-phylumid_kingdom[-7,]
```


Algunos phylum no tienen información del kingdom en NCBI únicamente de superkingdom, además algunos no tenían nada de información de ninguna de las dos cosas, en estos casos se buscó a mano y se puso la información encontrada en wiki por el momento, después se hará una búsqueda más detallada en la literatura.

Rhodophyta = Taxonomy NCBI solo tiene superkingdom eukarya wiki pone plantae/protista
Bacillariophyta =Taxonomy NCBI pone superkingdom eukarya wiki pone protista.
Foraminifera= Taxonomy NCBI pone eukarya wiki pone protista.
Chlorarachniophyceae= Taxonomy NCBI pone eukarya wiki pone protista.
Ciliophora=Taxonomy NCBI pone eukarya wiki protista.

Para Archea y Bacteria, Taxonomy NCBI las considera superkingdoms, por el momento se pusieron como kingdoms. 

```{r,  warning=FALSE, message=FALSE}
phylumid_kingdom$kingdom[12]<-"Protista"
phylumid_kingdom$kingdom[13]<-"Protista"
phylumid_kingdom$kingdom[16]<-"Protista"
phylumid_kingdom$kingdom[17]<-"Protista"
phylumid_kingdom$kingdom[29]<-"Protista"
phylumid_kingdom$kingdom[4]<-"Bacteria"
phylumid_kingdom$kingdom[7]<-"Archaea"
phylumid_kingdom$kingdom[8]<-"Bacteria"
phylumid_kingdom$kingdom[15]<-"Archaea"
```

Los siguientes phylum no aparecen en NCBI, la información por el momento viene de wiki, posteriormente se revisará la literatura. En el caso de Zygomicota en NCBI aparecen únicamente 4 subfilos, y son marcados como que pertenecen al reino Fungi.

```{r,  warning=FALSE, message=FALSE}
phylumid_kingdom[39,]<-c(NA, "Cryptophycophyta", "Protista")
phylumid_kingdom[40,]<-c(NA, "Heterokontophyta", "Protista")
phylumid_kingdom[41,]<-c(NA, "Ochrophyta", "Protista")
phylumid_kingdom[42,]<-c(NA, "Pinophyta", "Viridiplantae")
phylumid_kingdom[43,]<-c(NA, "Pteridophyta", "Viridiplantae")
phylumid_kingdom[44,]<-c(NA, "Pyrrophycophyta", "Protista")
phylumid_kingdom[45,]<-c(NA, "Zygomycota", "Fungi")

```

Se agrega la columna kingdom a los datos de BOLD:

```{r,  warning=FALSE, message=FALSE}
matched_phylum<-match(bold_data$phylum_name, phylumid_kingdom$phylum_name)
bold_data$kingdom<-phylumid_kingdom$kingdom[matched_phylum]
write.csv(bold_data, "./bold_data_complete")


```

Obtener la lista de secuencias por especie y el número de secuencias sin nombre de la especie:

```{r,  warning=FALSE, message=FALSE}

species_seqs<-as.data.frame(table(as.factor(bold_data$species_name)))
colnames(species_seqs)<- c("species_name", "number_seqs")
seqs_nospecies<-nrow(bold_data)-sum(species_seqs$number_seqs)
species_seqs<-cbind(as.character(species_seqs$species_name), species_seqs$number_seqs)
species_seqs<-as.data.frame(species_seqs)
nospecies<-cbind("No_species", seqs_nospecies)
colnames(nospecies)<-c("species_name", "number_seqs")
colnames(species_seqs)<-c("species_name", "number_seqs")
species_seqs<-rbind(species_seqs, nospecies)
write_csv(species_seqs, "./BOLD_specieslist.csv")


```

Agrupar los resultados por phylum y kingdom y hacer conteo:

```{r,  warning=FALSE, message=FALSE}
bold_phyl_king<-bold_data%>% group_by(phylum_name, kingdom) %>% summarise(n())
colnames(bold_phyl_king)<-c("Phylum", "Kingdom", "Num_seqs")

```


Número de secuencias por reino:
```{r,  warning=FALSE, message=FALSE}
king_seqs<-bold_phyl_king%>%group_by(Kingdom)%>%summarise(sum(Num_seqs))
colnames(king_seqs)<-c("kingdom", "num_seqs")
king_seqs
```


Plots:
```{r,  warning=FALSE, message=FALSE}

library(ggplot2)
library(plotly)
library(grid)
library(gridExtra)

king_plot1<-ggplot(data=king_seqs, aes(x=kingdom, y=num_seqs, fill=kingdom)) +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
king_plot2<-ggplot(data=king_seqs[-4,], aes(x=kingdom, y=num_seqs, fill=kingdom)) +
  geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))



```

```{r king_plot1, echo=FALSE, warning=FALSE}
king_plot1
```

```{r king_plot2, echo=FALSE, warning=FALSE}
king_plot2
```



Sacar lista de secuencias por phylum en cada reino:

```{r,  warning=FALSE, message=FALSE}
phylum_metazoa<-as.data.frame(table(as.factor(bold_data[which(bold_data$kingdom=="Metazoa"),10])))
colnames(phylum_metazoa)<-c("Phylum", "Num_seqs")
phylum_metazoa

```

```{r,  warning=FALSE, message=FALSE}

library(ggplot2)
library(plotly)
library(grid)
library(gridExtra)

metazoa_plot<-ggplot(data=phylum_metazoa, aes(x=Phylum, y=Num_seqs, fill=Phylum)) +
     ggtitle("Phylum en reino Metazoa") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
```


```{r metazoa_plot, echo=FALSE, warning=FALSE}
metazoa_plot

```



```{r,  warning=FALSE, message=FALSE}
phylum_plantae<-as.data.frame(table(as.factor(bold_data[which(bold_data$kingdom=="Viridiplantae"),10])))
colnames(phylum_plantae)<-c("Phylum", "Num_seqs")
phylum_plantae

```

```{r,  warning=FALSE, message=FALSE}

library(ggplot2)
library(plotly)
library(grid)
library(gridExtra)

plantae_plot<-ggplot(data=phylum_plantae, aes(x=Phylum, y=Num_seqs, fill=Phylum)) +
     ggtitle("Phylum en reino Viridiplantae") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
```


```{r plantae_plot, echo=FALSE, warning=FALSE}
plantae_plot

```

```{r,  warning=FALSE, message=FALSE}
phylum_fungi<-as.data.frame(table(as.factor(bold_data[which(bold_data$kingdom=="Fungi"),10])))
colnames(phylum_fungi)<-c("Phylum", "Num_seqs")
phylum_fungi

```

```{r, include=FALSE}

library(ggplot2)
library(plotly)
library(grid)
library(gridExtra)

fungi_plot<-ggplot(data=phylum_fungi, aes(x=Phylum, y=Num_seqs, fill=Phylum)) +
     ggtitle("Phylum en reino Fungi") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
```


```{r fungi_plot, echo=FALSE, warning=FALSE}
fungi_plot

```

```{r,  warning=FALSE, message=FALSE}
phylum_protista<-as.data.frame(table(as.factor(bold_data[which(bold_data$kingdom=="Protista"),10])))
colnames(phylum_protista)<-c("Phylum", "Num_seqs")
phylum_protista

```

```{r,  warning=FALSE, message=FALSE}

library(ggplot2)
library(plotly)
library(grid)
library(gridExtra)

protista_plot<-ggplot(data=phylum_protista, aes(x=Phylum, y=Num_seqs, fill=Phylum)) +
     ggtitle("Phylum en reino protista") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
```


```{r protista_plot, echo=FALSE, warning=FALSE}
protista_plot

```

```{r,  warning=FALSE, message=FALSE}
phylum_bacteria<-as.data.frame(table(as.factor(bold_data[which(bold_data$kingdom=="Bacteria"),10])))
colnames(phylum_bacteria)<-c("Phylum", "Num_seqs")
phylum_bacteria

```

```{r,  warning=FALSE, message=FALSE}

library(ggplot2)
library(plotly)
library(grid)
library(gridExtra)

bacteria_plot<-ggplot(data=phylum_bacteria, aes(x=Phylum, y=Num_seqs, fill=Phylum)) +
     ggtitle("Phylum en reino Bacteria") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
```


```{r bacteria_plot, echo=FALSE, warning=FALSE}
bacteria_plot

```

```{r,  warning=FALSE, message=FALSE}
phylum_archaea<-bold_data[which(bold_data$kingdom=="Archaea"),c(81,10,12,14,16,18,22)]
phylum_archaea
```


 
```{r,  warning=FALSE, message=FALSE}
nospecies<-bold_data[which(is.na(bold_data$species_name)), c(81,10,12,14,16,18,22)]

```



```{r,  warning=FALSE, message=FALSE}
nospecies_phyl_king<-nospecies%>% group_by(phylum_name, kingdom) %>% summarise(n())
colnames(nospecies_phyl_king)<-c("Phylum", "Kingdom", "Num_seqs")
```




Número de secuencias por reino (sin nombre de la especie):
```{r,  warning=FALSE, message=FALSE}
nosp_king<-nospecies_phyl_king%>%group_by(Kingdom)%>%summarise(sum(Num_seqs))
colnames(nosp_king)<-c("kingdom", "num_seqs")
nosp_king
```


Agregar variables binarias que indiquen la información geográfica con la que se cuenta:
```{r,  warning=FALSE, message=FALSE}
bold_data$provincestate_info<-NA
bold_data$region_info<-NA
bold_data$sector_info<-NA
bold_data$exactsite_info<-NA
bold_data$latlon_info<-NA

bold_data$provincestate_info<-is.na(bold_data$province_state)==FALSE
bold_data$region_info<-is.na(bold_data$region)==FALSE
bold_data$sector_info<-is.na(bold_data$sector)==FALSE
bold_data$exactsite_info<-is.na(bold_data$exactsite)==FALSE
bold_data$latlon_info<-is.na(bold_data$lat)==FALSE

data_latlon_kin<-bold_data%>%group_by(kingdom, latlon_info)%>%summarise(n())
colnames(data_latlon_kin)<-c("kingdom", "latlon_info", "num_seqs")
write_tsv(data_latlon_kin, "latlon_bold.tsv")
data_latlon_kin
```



```{r, warning=F, message=F, echo=F}

reinos_latlon_plot<-ggplot(data_latlon_kin, aes(factor(kingdom), num_seqs, fill=latlon_info)) +
 geom_bar(stat="identity", position = "dodge") + 
  scale_fill_brewer(palette = "Set1") + ggtitle("Datos con/sin coordinadas por reinos")

reinos_latlon_plot2<-ggplot(data_latlon_kin[-(7:8),], aes(factor(kingdom), num_seqs, fill=latlon_info)) +
 geom_bar(stat="identity", position = "dodge") + 
  scale_fill_brewer(palette = "Set1") + ggtitle("Datos con/sin coordinadas por reinos, excluyendo Metazoa")


```

```{r reinos_latlon_plot, message=FALSE, warning=FALSE}
reinos_latlon_plot
```


```{r reinos_latlon_plot2, message=FALSE, warning=FALSE}
reinos_latlon_plot2
```

Separar los datos que no tienen info de coordenadas. Hay 13120 observaciones que no cuentan con coordenadas. 

```{r, warning=FALSE, message=FALSE}
bold_nlatlon<-bold_data[which(is.na(bold_data$lon)),]
bold_nlatlon<-bold_nlatlon[which(is.na(bold_nlatlon$lat)),]
nrow(bold_nlatlon)
```

Analizar que información geográfica hay para los datos que no poseen coordenadas.

Datos de país (México)
El data frame bold data tiene 87682 observaciones, como se puede ver para los datos de BOLD todos tienen como país México (eso incluiría todos los que no tienen latitud y longitud)
```{r, warning=FALSE, message=FALSE}
nrow(bold_data[bold_data$country=="Mexico",])
```

Datos de estado o provincia.

```{r, warning=FALSE, message=FALSE}
ncoo_phylkin_prov<-bold_nlatlon%>% group_by(phylum_name, kingdom, provincestate_info) %>% summarise(n())
colnames(ncoo_phylkin_prov)<-c("phylum_name", "kingdom", "provincestate_info", "num_seqs")
ncoo_king_prov<-bold_nlatlon%>%group_by(kingdom, provincestate_info)%>%summarise(n())
colnames(ncoo_king_prov)<-c("kingdom", "province_state_info", "num_seqs")
ncoo_king_prov
```

Datos de region.
```{r, warning=FALSE, message=FALSE}
ncoo_phylkin_reg<-bold_nlatlon%>% group_by(phylum_name, kingdom, region_info) %>% summarise(n())
colnames(ncoo_phylkin_reg)<-c("phylum_name", "kingdom", "region_info", "num_seqs")
ncoo_king_reg<-bold_nlatlon%>%group_by(kingdom, region_info)%>%summarise(n())
colnames(ncoo_king_reg)<-c("kingdom", "region_info", "num_seqs")
ncoo_king_reg
```
Datos de sector.
```{r, warning=FALSE, message=FALSE}
ncoo_phylkin_sec<-bold_nlatlon%>% group_by(phylum_name, kingdom, sector_info) %>% summarise(n())
colnames(ncoo_phylkin_sec)<-c("phylum_name", "kingdom", "sector_info", "num_seqs")
ncoo_king_sec<-bold_nlatlon%>%group_by(kingdom, sector_info)%>%summarise(n())
colnames(ncoo_king_sec)<-c("kingdom", "sector_info", "num_seqs")
ncoo_king_sec
```



Datos del sitio exacto.
```{r, warning=FALSE, message=FALSE}
ncoo_phylkin_exsit<-bold_nlatlon%>% group_by(phylum_name, kingdom, exactsite_info) %>% summarise(n())
colnames(ncoo_phylkin_exsit)<-c("phylum_name", "kingdom", "exactsite_info", "num_seqs")
ncoo_king_exsit<-bold_nlatlon%>%group_by(kingdom, exactsite_info)%>%summarise(n())
colnames(ncoo_king_exsit)<-c("kingdom", "exactsite_info", "num_seqs")
ncoo_king_exsit
```


Plots informacion geografica

```{r,  warning=FALSE, message=FALSE}

library(ggplot2)
library(plotly)
library(grid)
library(gridExtra)
prov_kin_plot<-ggplot(ncoo_king_prov, aes(x=kingdom, y=num_seqs, fill=province_state_info)) +
     ggtitle("Observaciones sin coordenadas, datos del estado.") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))

sec_kin_plot<-ggplot(ncoo_king_sec, aes(x=kingdom, y=num_seqs, fill=sector_info)) +
     ggtitle("Observaciones sin coordenadas, datos del sector") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
exsit_kin_plot<-ggplot(ncoo_king_exsit, aes(x=kingdom, y=num_seqs, fill=exactsite_info)) +
     ggtitle("Observaciones sin coordenadas, datos del sitio exacto") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
reg_kin_plot<-ggplot(ncoo_king_reg, aes(x=kingdom, y=num_seqs, fill=region_info)) +
     ggtitle("Observaciones sin coordenadas, datos de la región") +
     geom_bar(stat="identity")+ theme(axis.text.x = element_text(angle = 90))
```

Filtro para trabajo de distribución geográfica (por phylum) y data frame de datos taxonómicos, para plantas. 

```{r, warning=F, message=F}
plant_b<-unique(bold_data[bold_data$kingdom=="Viridiplantae", c(10,12,14,16,18,20,22,81)])
write.csv(plant_b, "plants_bold.csv")
data_filtered<-bold_data %>% filter(!(is.na(species_name))) %>% filter (phylum_name=="Magnoliophyta" | phylum_name=="Pinophyta" | phylum_name=="Chordata" | phylum_name=="Arthropoda" | phylum_name =="Ascomycota" | phylum_name=="Basidiomycota")
write_csv(data_filtered, "BOLD_data_ph.csv")
```










